<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Homelab Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            mono: ['JetBrains Mono', 'monospace'],
            sans: ['Inter', 'system-ui', 'sans-serif']
          },
          colors: {
            mil: {
              black: 'var(--mil-black)',
              dark: 'var(--mil-dark)',
              card: 'var(--mil-card)',
              border: 'var(--mil-border)',
              text: 'var(--mil-text)',
              muted: 'var(--mil-muted)',
              accent: '#f97316',
              accentDim: '#c2410c',
              success: '#22c55e',
              error: '#ef4444',
            }
          }
        }
      }
    }
  </script>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    crossorigin="anonymous" />
  <link rel="stylesheet" href="/static/css/animations.css" />
  <link rel="stylesheet" href="/static/css/dashboard.css" />
  <!-- Three.js & Loading Screen -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    // Pass loading screen settings from server
    window.loadingScreenStyle = '{{ appearance.loading_screen_style | default("server") }}';
    window.showLoadingScreen = {{ 'true' if appearance.show_loading_screen | default (true) else 'false' }};
  </script>
  <!-- Loading Screen Logic -->
  <script src="{{ url_for('static', filename='js/loading/viz_terrain.js') }}"></script>
  <script src="{{ url_for('static', filename='js/loading/viz_server.js') }}"></script>
  <script src="{{ url_for('static', filename='js/loading/core.js') }}"></script>
</head>

<body class="min-h-screen bg-mil-black text-mil-text font-sans relative">
  {% if appearance.show_loading_screen %}
  {% include 'partials/dashboard/loading_screen.html' %}
  {% endif %}

  <!-- Dynamic Grid Background -->
  <div class="grid-background"></div>

  {% include 'partials/dashboard/tickers.html' %}

  {% include 'partials/dashboard/header.html' %}

  <main class="max-w-7xl mx-auto px-6 py-8">
    <!-- Services Section -->
    <section class="mb-10" data-animate="slide-up">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <h2 class="text-xs font-mono font-bold uppercase tracking-widest text-mil-muted">ACTIVE SERVICES</h2>
          <span id="refresh-indicator" class="htmx-indicator text-mil-accent text-xs">
            <i class="fa-solid fa-circle-notch animate-spin"></i>
          </span>
        </div>
        <span class="text-[10px] font-mono text-mil-muted">DRAG TO REORDER</span>
      </div>
      <div id="apps-container" hx-get="/api/apps" hx-trigger="load" hx-swap="innerHTML"
        hx-indicator="#refresh-indicator" data-animate="scale">
        {% include 'partials/apps.html' %}
      </div>
    </section>

    <!-- Stats Grid -->
    <section class="mb-10" data-animate="slide-up">
      <h2 class="text-xs font-mono font-bold uppercase tracking-widest text-mil-muted mb-4">SYSTEM METRICS</h2>
      <div id="live-stats" hx-get="/api/stats" hx-trigger="load, every 2s" hx-swap="innerHTML" data-animate="glitch">
        {% include 'partials/stats.html' %}
      </div>
    </section>

    <!-- Integrations Section -->
    {% set has_integrations = (integrations.pihole.enabled if integrations and integrations.pihole else false) or
    (integrations.speedtest.enabled if integrations and integrations.speedtest else false) or
    (integrations.uptime_kuma.enabled if integrations and integrations.uptime_kuma else false) or
    (integrations.audiobookshelf.enabled if integrations and integrations.audiobookshelf else false) %}
    {% if has_integrations %}
    <section class="mb-10" data-animate="slide-up">
      <h2 class="text-xs font-mono font-bold uppercase tracking-widest text-mil-muted mb-4">INTEGRATIONS</h2>
      <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        {% if integrations and integrations.pihole and integrations.pihole.enabled %}
        <div hx-get="/api/widgets/pihole" hx-trigger="load, every 30s" hx-swap="innerHTML" data-animate="scale">
          <div class="h-48 bg-mil-card border border-mil-border animate-pulse"></div>
        </div>
        {% endif %}
        {% if integrations and integrations.speedtest and integrations.speedtest.enabled %}
        <div hx-get="/api/widgets/speedtest" hx-trigger="load, every 60s" hx-swap="innerHTML" data-animate="scale">
          <div class="h-48 bg-mil-card border border-mil-border animate-pulse"></div>
        </div>
        {% endif %}
        {% if integrations and integrations.uptime_kuma and integrations.uptime_kuma.enabled %}
        <div hx-get="/api/widgets/uptime-kuma" hx-trigger="load, every 30s" hx-swap="innerHTML" data-animate="scale">
          <div class="h-48 bg-mil-card border border-mil-border animate-pulse"></div>
        </div>
        {% endif %}
        {% if integrations and integrations.audiobookshelf and integrations.audiobookshelf.enabled %}
        <div class="md:col-span-2 lg:col-span-3 h-64" hx-get="/api/widgets/audiobookshelf" hx-trigger="load, every 300s"
          hx-swap="innerHTML" data-animate="scale">
          <div class="h-full bg-mil-card border border-mil-border animate-pulse"></div>
        </div>
        {% endif %}
      </div>
    </section>
    {% endif %}

    <!-- Threat Monitor Section - Full Width -->
    <!-- Threat Monitor Section - Full Width -->
    {% if widgets.threats.enabled %}
    <section class="mb-10" data-animate="slide-up">
      <h2 class="text-xs font-mono font-bold uppercase tracking-widest text-mil-muted mb-4">GLOBAL THREAT ASSESSMENT
      </h2>
      <div hx-get="/api/widgets/threats-full" hx-trigger="load, every 120s" hx-swap="innerHTML" data-animate="glitch">
        <div class="h-64 bg-mil-card border border-mil-border animate-pulse"></div>
      </div>
    </section>
    {% endif %}

    <!-- Intel Feeds Grid -->
    <!-- Intel Feeds Grid -->
    <section data-animate="slide-up">
      <h2 class="text-xs font-mono font-bold uppercase tracking-widest text-mil-muted mb-4">INTEL FEEDS</h2>
      <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        {% if widgets.news.enabled %}
        <div hx-get="/api/widgets/news-detailed" hx-trigger="load" hx-swap="innerHTML" data-animate="scale">
          <div class="h-72 bg-mil-card border border-mil-border animate-pulse"></div>
        </div>
        {% endif %}
        {% if widgets.reddit.enabled %}
        <div hx-get="/api/widgets/reddit-detailed?sub=worldnews" hx-trigger="load" hx-swap="innerHTML"
          data-animate="scale">
          <div class="h-72 bg-mil-card border border-mil-border animate-pulse"></div>
        </div>
        <div hx-get="/api/widgets/reddit-detailed?sub=homelab" hx-trigger="load" hx-swap="innerHTML"
          data-animate="scale">
          <div class="h-72 bg-mil-card border border-mil-border animate-pulse"></div>
        </div>
        {% endif %}
      </div>
    </section>
  </main>

  {% include 'partials/dashboard/edit_panel.html' %}

  {% include 'partials/dashboard/terminal_overlay.html' %}

  <!-- xterm.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.js"></script>

  <!-- SortableJS for proper drag and drop -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script>
    // Pass server-side variables to window for JS modules
    window.locationSettings = {
      useAuto: {{ (location.use_auto | default (true)) | tojson }},
    city: { { (location.city | default ('')) | tojson } },
    latitude: { { (location.latitude | default ('')) | tojson } },
    longitude: { { (location.longitude | default ('')) | tojson } },
    units: { { (location.units | default ('imperial')) | tojson } }
    };
  </script>
  <script src="{{ url_for('static', filename='js/dashboard/ui.js') }}?v=2"></script>
  <script src="{{ url_for('static', filename='js/dashboard/terminal.js') }}"></script>
</body>

</html>