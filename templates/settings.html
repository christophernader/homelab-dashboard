<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings | Homelab Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            mono: ['JetBrains Mono', 'monospace'],
            sans: ['Inter', 'system-ui', 'sans-serif']
          },
          colors: {
            mil: {
              black: '#0a0a0a',
              dark: '#111111',
              card: '#151515',
              border: '#252525',
              text: '#e5e5e5',
              muted: '#6b6b6b',
              accent: '#f97316',
              success: '#22c55e',
              error: '#ef4444',
            }
          }
        }
      }
    }
  </script>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    crossorigin="anonymous" />
  <link rel="stylesheet" href="/static/css/settings.css" />
</head>

<body class="min-h-screen bg-mil-black text-mil-text font-sans">
  <!-- Toast Notification Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

  <!-- Header -->
  <header class="border-b border-mil-border bg-mil-dark">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <a href="/" class="flex items-center gap-3 text-mil-muted hover:text-mil-text transition-colors">
          <i class="fa-solid fa-arrow-left"></i>
          <span class="text-xs font-mono uppercase tracking-wider">Back to Dashboard</span>
        </a>
      </div>
      <h1 class="text-sm font-mono uppercase tracking-widest text-mil-accent">Settings</h1>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-8">
    <!-- Tab Navigation -->
    <div class="flex gap-2 border-b border-mil-border mb-8">
      <button onclick="showTab('widgets')" id="tab-widgets"
        class="tab-btn px-4 py-3 text-xs font-mono uppercase tracking-wider border-b-2 border-mil-accent text-mil-accent">
        <i class="fa-solid fa-puzzle-piece mr-2"></i> Widgets
      </button>
      <button onclick="showTab('integrations')" id="tab-integrations"
        class="tab-btn px-4 py-3 text-xs font-mono uppercase tracking-wider border-b-2 border-transparent text-mil-muted hover:text-mil-text">
        <i class="fa-solid fa-plug mr-2"></i> Integrations
      </button>
      <button onclick="showTab('appearance')" id="tab-appearance"
        class="tab-btn px-4 py-3 text-xs font-mono uppercase tracking-wider border-b-2 border-transparent text-mil-muted hover:text-mil-text">
        <i class="fa-solid fa-palette mr-2"></i> Appearance
      </button>
      <button onclick="showTab('dashboard')" id="tab-dashboard"
        class="tab-btn px-4 py-3 text-xs font-mono uppercase tracking-wider border-b-2 border-transparent text-mil-muted hover:text-mil-text">
        <i class="fa-solid fa-gauge-high mr-2"></i> Dashboard
      </button>
    </div>

    <!-- Widgets Tab -->
    {% include 'partials/settings/widgets.html' %}

    <!-- Integrations Tab -->
    {% include 'partials/settings/integrations.html' %}

    <!-- Appearance Tab -->
    {% include 'partials/settings/appearance.html' %}

    <!-- Dashboard Tab -->
    {% include 'partials/settings/dashboard.html' %}
  </main>

  <script>
    function showTab(tabName) {
      // Hide all panels
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
      // Deactivate all tabs
      document.querySelectorAll('.tab-btn').forEach(t => {
        t.classList.remove('border-mil-accent', 'text-mil-accent');
        t.classList.add('border-transparent', 'text-mil-muted');
      });
      // Show selected panel
      document.getElementById(`panel-${tabName}`).classList.remove('hidden');
      // Activate selected tab
      const tab = document.getElementById(`tab-${tabName}`);
      tab.classList.remove('border-transparent', 'text-mil-muted');
      tab.classList.add('border-mil-accent', 'text-mil-accent');
    }

    // Toast notification function
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');

      const bgColor = type === 'success' ? 'bg-mil-success' : 'bg-mil-error';
      const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';

      toast.className = `${bgColor} text-mil-black px-4 py-3 font-mono text-xs uppercase tracking-wider flex items-center gap-2 shadow-lg transform translate-x-full transition-transform duration-300`;
      toast.innerHTML = `<i class="fa-solid ${icon}"></i> ${message}`;

      container.appendChild(toast);

      // Animate in
      requestAnimationFrame(() => {
        toast.classList.remove('translate-x-full');
      });

      // Remove after 3 seconds
      setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Handle HTMX responses for feedback
    document.body.addEventListener('htmx:afterRequest', (e) => {
      const xhr = e.detail.xhr;
      const path = e.detail.pathInfo.requestPath;

      // Skip toggle requests (they're quick and don't need feedback)
      if (path.includes('/toggle')) return;

      try {
        const response = JSON.parse(xhr.responseText);

        if (xhr.status >= 200 && xhr.status < 300) {
          // Success
          if (path.includes('/test')) {
            showToast(response.message || 'Connection successful', 'success');
          } else {
            showToast(response.message || 'Settings saved', 'success');
          }
        } else {
          // Error
          showToast(response.message || 'Operation failed', 'error');
        }
      } catch (err) {
        // Non-JSON response or parse error
        if (xhr.status >= 200 && xhr.status < 300) {
          if (path.includes('/test')) {
            showToast('Connection successful', 'success');
          } else {
            showToast('Settings saved', 'success');
          }
        } else {
          showToast('Operation failed', 'error');
        }
      }
    });

    // Handle HTMX errors
    document.body.addEventListener('htmx:responseError', (e) => {
      const xhr = e.detail.xhr;
      try {
        const response = JSON.parse(xhr.responseText);
        showToast(response.message || 'Connection failed', 'error');
      } catch (err) {
        showToast('Connection failed', 'error');
      }
    });
  </script>
</body>

</html>